# backend-portlandredbird-v2
In-progress. A `Node.js` backend for the art portfolio at portlandredbird.com. Offers authorized access to backend services for use by frontend and admin tool clients.


# Content Management
This section of the readme details the routes and database structure for managing the content of the portfolio

## Content Management Routes
The frontend client must be authorized with an API key in the `x-api-key` field of the request header in order to use these routes.

### /artRoutes
Serves information about the art in the portfolio. The frontend can call these routes and get the following information about an image:
- Image URL
- Description
- Alt Text

### /upload
Authorized users can upload images to the file bucket and the details to the `PostgreSQL` database. Must include a description and alt text in the request.

Current iteration of the software overwrites images of the same name, but future iterations will provide response interface that allows the frontend to change the name or overwrite depending.

### /delete
Authorized users can delete images from the database and image bucket


## Art Portfolio Database Structure
The art portfolio website uses a PostgreSQL database to store information about images and their associated tags. The database has three tables: `portfolio_images`, `portfolio_tags`, and `portfolio_image_tags_assoc`.

### Content Tables
#### `portfolio_images`: Stores information about each image in the portfolio.

- `filename`      (TEXT, PRIMARY KEY): The filename where the image is stored.
- `description`   (TEXT): A brief description of the image.
- `alt_text`      (TEXT): The alt text for the image, used for accessibility.
- `bucket_url`    (TEXT): The url for the location of the image (does not include filename)

#### `portfolio_tags`: Stores the unique tags used to categorize images in the portfolio.

- `tag_id`        (SERIAL, PRIMARY KEY): A unique identifier for each tag.
- `tag_name`      (TEXT, UNIQUE): The name of the tag.

#### `portfolio_image_tags_assoc`: Association table that maps the relationships between images and their associated tags.

- `filename`      (TEXT, FOREIGN KEY referencing `portfolio_images.filename`): The url location of the image.
- `tag_id`        (INTEGER, FOREIGN KEY referencing `portfolio_tags.tag_id`): The unique identifier of the tag.
PRIMARY KEY       (filename, tag_id)

This database structure creates a many-to-many relationship between images and tags, allowing each image to have multiple tags and each tag to be associated with multiple images. The image_tags table serves as a junction table that links images and tags, enabling efficient querying and management of the relationships between them.



# User Management

## User Database Structure
### `users`: Table that tracks user login details. These logins are to be used with the [`pixelpusher` app](https://github.com/CzerPDX/pixelpusher) to manage the ability to add files to the file buckets they have access to.

- `user_id`         (SERIAL, PRIMARY KEY): A unique identifier for each user account. Automatically generated by the postgres database
- `email`           (TEXT, UNIQUE): The email address of the user
- `hashed_password` (TEXT): The hashed password for the user
- `created_at`      (TIME WITH TIME ZONE):  The time the user entry was added to the database. Automatically managed using triggers inside the database.
- `updated_at`      (TIME WITH TIME ZONE): The time the user entry was last updated. Automatically managed using triggers inside the database.
- `bucket_access`   (TEXT ARRAY): The names of the file buckets the user has access to. (for example: `demo`, `art`, etc)

## User Management Routes
Users will be managed with a stateless JWT system. JWT will include the user's email as well as their allowed buckets which is currently all the information the UI will require. In future iterations it may be helpful to add a user object that gets returned but for now we are only going to require information that is already in the JWT.

### `/register`: POST
Requires:
- email (unique)
- password

Returns:
- JWT that logs user into new account

Users can register using this route. However, general registration is restricted so you must have api-key access to register.

### `/register-demo`: POST
Requires:
- email (unique)
- password

Returns:
- JWT that logs user into new account

This is the general frontend registration for demo purposes. This route does not require special authorization to register. It will automatically add the user into the demo bucket group so prospective employers are able to see the functionality of the system without the ability to access existing image data on the database.

### `/login`: POST
Requires:
- email
- password

Returns:
- JWT that logs user into account

This is the login route that will be used. Sends a JWT back to the client.

### `/delete-user`: DELETE
Requires:
- email
- password
- valid JWT

This route allows the logged-in user associated with the provided valid JWT to delete their account. Email and password are required for extra security for account deletion. User's JWT should be discarded by the client when this route is used. If the user's password is incorrect it will return a failure HTTP code.

### `/change-password`: POST
Requires:
- valid JWT
- Old password
- New password

This route allows the logged-in user associated with the provided valid JWT to update their password. Old password is required for extra security.

### `/forgot-password`: POST
Requires:
- email

This route will allow users who have forgotten their password to get a reset password link sent to them via email. A reset link is sent immediately after the request. The system will implement rate limiting or CAPTCHA to prevent abuse.

### `/add-bucket-access`: POST
Requires:
- valid JWT
- API access key

This route allows the logged-in user associated with the provided valid JWT to add bucket access. However, this operation is restricted to administrators. A valid API access key is required in the request to verify the requester's administrative privileges.

### `/remove-bucket-access`: DELETE
Requires:
- valid JWT
- API access key

This route allows the logged-in user associated with the provided valid JWT to remove bucket access. However, this operation is restricted to administrators. A valid API access key is required in the request to verify the requester's administrative privileges.

### `/get-user-info`: GET
Requires:
- valid JWT

Returns:
- All columns (except `hashed_password`) for the user in the `users` table.


# Testing
This application uses jest for testing. To run tests type `npm run test` in the command line.
